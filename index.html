<!DOCTYPE html>
<html>
  <head>
    <title>The Shenango Channel</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <style type='text/css'>
      html, body {
        width: 100%;
        height: 100%;
        min-width: 770px;
        min-height: 745px;
        margin: 0;
      }

      #page_container {
        width: 100%;
        height: 100%;
        margin: 0;
        border-spacing: 0;
        border-collapse: collapse;
      }

      #page_container tr:not(.grapher_row) {
        height: 50%;
      }

      .row1 {
        display:table-row;
        height: 50%;
        width: 100%;
        background: white;
      }

      .row1 div {
        display: table-cell;
        width: 100%;
      }

      .row2 {
        display: table-row;
        height: 100%;
        width: 100%;
      }

      .row2 div {
        width: 50%;
        height: 100%;
        background: transparent;
      }

      .row2 div + div {
        background: transparent;
        width: 50%;
        height: 100%;
        position: static;
        top: 0;
        right: 0;
      }

      #map-canvas {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      #grapher {
        font-size: 10pt !important;
        position: relative;
        width: 100%;
        min-width: 385px;
        height: 100%;
      }

      #dateAxisContainer {
        width: 100%;
        height: 39px;
        position: relative;
      }

      #dateAxis {
        position: absolute;
        right: 250px;
        left: 159px;
        top: 0px;
        height: 38px;
        border: 1px solid black;
        width: 100%;
        background: white;
      }

      .chart {
        height: auto;
        background: #4f5457 !important;
      }

      .chartTitle {
        position: absolute;
        left: 0px;
        width: 136px;
        height: auto;
        border: 1px solid black;
        font-family: 'Helvetica Neue', Helvetica, Arial;
        color: white;
        padding: 11px
      }

      .chartContent {
        position: absolute;
        left: 159px;
        right: 35px;
        height: auto;
        border: 1px solid black;
        background: white;
      }

      .annotationContent {
        position: absolute;
        left: 159px;
        right: 35px;
        height: 35px;
        border: 1px solid black;
        background: white;
      }

      .annotationChart {
        height: 35px;
        background: #4f5457 !important;
      }

      .annotationChartTitle {
        position: absolute;
        left: 0px;
        width: 136px;
        height: 35px;
        border: 1px solid black;
        font-family: 'Helvetica Neue', Helvetica, Arial;
        color: white;
        padding: 11px
      }

      .chartAxis {
        position: absolute;
        right: 0px;
        width: 34px;
        height: 100%;
        border: 1px solid black;
        background: white;
      }

      #sensorColumnTitle {
        background: rgb(214, 208, 208);
        padding-left: 12px;
        text-decoration: underline;
        font-size: 15px;
        border-top: 1px solid black;
        width: 160px;
      }
    </style>

    <link href="assets/timemachine-viewer/css/jquery-ui/smoothness/jquery-ui.custom.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="assets/timemachine-viewer/css/defaultUI.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="assets/css/application.css" media="screen" rel="stylesheet" type="text/css" />

    <script src="assets/timemachine-viewer/js/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/js/jquery/plugins/mouse/jquery.mousewheel.min.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/js/org/gigapan/util.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/js/org/gigapan/timelapse/videoset.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/js/org/gigapan/timelapse/parabolicMotion.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/js/org/gigapan/timelapse/timelapse.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/js/Math.uuid.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/js/org/gigapan/timelapse/snaplapse.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/js/org/gigapan/timelapse/snaplapseViewer.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/js/org/gigapan/timelapse/defaultUI.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/js/org/gigapan/timelapse/crossdomain_api.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/template_includes.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/libs/change-detect/js/ThumbnailServiceAPI.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/libs/change-detect/js/TimeMachineCanvasLayer.js" type="text/javascript"></script>
    <script src="assets/timemachine-viewer/libs/change-detect/js/ThumbnailTool.js" type="text/javascript"></script>
    <script src="http://tiles.cmucreatelab.org/ecam/timemachines/shenango1/shenango1.js" type="text/javascript"></script>
    <script src="assets/js/jquery.xdomainrequest.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="assets/grapher/grapher2.nocache.js" type="text/javascript"></script>
    <script src="map.js"></script>
    <script src="smell.js"></script>
    <script src="assets/data-visualization-tools/js/CanvasLayer.js"></script>

    <script>
      "use strict";
      jQuery.support.cors = true;
      var zoomify, locationDivId, timelapse, timelapseFeedUnavailable, hashVars, dateAxis;
      var pageLoadDate = cached_breathecam.latest.date;
      var series = [];
      var currentLocation = "shenango1";
      var currentDate;
      var ESDR_API_ROOT_URL = 'http://esdr.cmucreatelab.org/api/v1';
      var clampTimeout = null;
      var fixedCursorPosition;

      var esdr_feeds = {
        ACHD_Avalon : {
          feed_id: 1,
          coordinates : {
            latitude: 40.499767,
            longitude: -80.072
          },
          api_key: "8a2ce5c845ca323d80056aefd564f6f7305724a0476318e488c5ea380094ebc2",
          requested_day: {},
          channels : {
            "PM25B_UG_M3": {
              show_graph: true,
              hourly : true,
              graphMetaData : {
                label: "ACHD: Avalon - PM<sub>2.5</sub>, &mu;g/m<sup>3</sup>",
                color: "10,104,177"
              },
              summary: {}
            },
            "SONICWS_MPH": {
              show_graph: false,
              hourly : true,
              summary: {}
            },
            "SONICWD_DEG": {
              show_graph: false,
              hourly : true,
              summary: {}
            }
          },
          fullTimeRange: {}
        },
        Speck1 : {
          feed_id: 4315,
          coordinates : {
            latitude: 40.499767,
            longitude: -80.068
          },
          requested_day: {},
          api_key: "10a87f12202b19fc32273b8681ea3ce612cae0472eba3497dda5c96d814f66c8",
          channels: {
            particle_concentration : {
              show_graph: true,
              graphMetaData : {
                label: "Avalon Speck - <br> PM<sub>2.5</sub>, &mu;g/m<sup>3</sup>",
                color: "127, 57, 148"
              },
              summary: {}
            }
          },
          fullTimeRange: {}
        },
        Speck1b : {
          feed_id: 4615,
          coordinates : {
            latitude: 40.499767,
            longitude: -80.068
          },
          requested_day: {},
          api_key: "ab8326a706346a2e44badbdb764320f0760f9b950c99a5406bbea3498635bcd4",
          channels: {
            particle_concentration : {
              show_graph: true,
              graphMetaData : {
                label: "Avalon Speck - <br> PM<sub>2.5</sub>, &mu;g/m<sup>3</sup>",
                color: "127, 57, 148"
              },
              summary: {}
            }
          },
          fullTimeRange: {}
        },
        Speck2 : {
          feed_id: 4617,
          coordinates : {
            latitude: 40.501,
            longitude: -80.061
          },
          requested_day: {},
          api_key: "3c9286797e517dacd885309bb8e88a1309a9bdd0e7655bcfa1c47fa47f7c7b76",
          channels: {
            particle_concentration : {
              show_graph: true,
              graphMetaData : {
                label: "Bellevue Speck 2 - PM<sub>2.5</sub>, &mu;g/m<sup>3</sup>",
                color: "201, 23, 30"
              },
              summary: {}
            }
          },
          fullTimeRange: {}
        },
        Speck3 : {
          feed_id: 4316,
          coordinates : {
            latitude: 40.508,
            longitude: -80.076
          },
          requested_day: {},
          api_key: "02e22d5b3a81370d60d265d9ae9e61e1ddbb276f5aafe894c5f7de424e849147",
          channels: {
            particle_concentration : {
              show_graph: true,
              graphMetaData : {
                label: "Ben Avon Speck - PM<sub>2.5</sub>, &mu;g/m<sup>3</sup>",
                color: "230, 120, 26"
              },
              summary: {}
            }
          },
          fullTimeRange: {}
        },
        Speck3b : {
          feed_id: 4616,
          coordinates : {
            latitude: 40.508,
            longitude: -80.076
          },
          requested_day: {},
          api_key: "4b0f52af05a2ac8354663b00eb61d80015b6a49e2b20b7094a8c137f2535055d",
          channels: {
            particle_concentration : {
              show_graph: true,
              graphMetaData : {
                label: "Ben Avon Speck 2 - PM<sub>2.5</sub>, &mu;g/m<sup>3</sup>",
                color: "230, 120, 26"
              },
              summary: {}
            }
          },
          fullTimeRange: {}
        },
        ACHD_North_Braddock : {
          feed_id: 3,
          coordinates : {
            latitude: 40.402,
            longitude: -79.860
          },
          requested_day: {},
          api_key: "3c607ed62b70fd874e62c8aea4c40811398c6ddcf5dc3e15edfc4cda4dc256d6",
          channels: {
            "SONICWS_MPH": {
              show_graph: false,
              hourly : true,
              summary: {}
            },
            "SONICWD_DEG": {
              show_graph: false,
              hourly : true,
              summary: {}
            }
          },
          fullTimeRange: {}
        },
        ACHD_Lawrenceville : {
          feed_id: 26,
          coordinates : {
            latitude: 40.465,
            longitude: -79.960
          },
          requested_day: {},
          api_key: "01aceb2dd35a61aadb5992292ee7cc34ec8d044ccf8d49b4b24c9c335476616c",
          channels: {
            "SONICWS_MPH": {
              show_graph: false,
              hourly : true,
              summary: {}
            },
            "SONICWD_DEG": {
              show_graph: false,
              hourly : true,
              summary: {}
            }
          },
          fullTimeRange: {}
        },
        ACHD_Parkway_East : {
          feed_id: 43,
          coordinates : {
            latitude: 40.437,
            longitude: -79.863
          },
          requested_day: {},
          api_key: "bf61b67e0b93d612dacf8f9f034fba75da9141046df38fd058b44fdb1076ab9f",
          channels: {
            "SONICWS_MPH": {
              show_graph: false,
              hourly : true,
              summary: {}
            },
            "SONICWD_DEG": {
              show_graph: false,
              hourly : true,
              summary: {}
            }
          },
          fullTimeRange: {}
        },
        ACHD_Liberty : {
          feed_id: 28,
          coordinates : {
            latitude: 40.323,
            longitude: -79.868
          },
          requested_day: {},
          api_key: "ce7e8af4e53980642fd0249808af4f55bcfb00744207106a5b000119a0c5e189",
          channels: {
            "SONICWS_MPH": {
              show_graph: false,
              hourly : true,
              summary: {}
            },
            "SONICWD_DEG": {
              show_graph: false,
              hourly : true,
              summary: {}
            }
          },
          fullTimeRange: {}
        },
        ACHD_South_Fayette : {
          feed_id: 32,
          coordinates : {
            latitude: 40.375,
            longitude: -80.169
          },
          requested_day: {},
          api_key: "fd7a17dee775a42a97a0a87d9ba504a172e1fe46b466f8ae2972df1dcf105b7c",
          channels: {
            "SONICWS_MPH": {
              show_graph: false,
              hourly : true,
              summary: {}
            },
            "SONICWD_DEG": {
              show_graph: false,
              hourly : true,
              summary: {}
            }
          },
          fullTimeRange: {}
        }
      };

      function tm_init() {
        selectTimelapseFeed();

        var initialDataset = cached_breathecam.latest.path;
        var startingDate = cached_breathecam.latest.date;

        var hash = window.location.hash.slice(1);
        hashVars = org.gigapan.Util.unpackVars(hash);
        var loadedTimelapse = false;
        if (hashVars) {
          if (hashVars.d) {
            startingDate = String(hashVars.d);
            initialDataset = cached_breathecam.datasets[startingDate];
            if (!initialDataset) {
              initialDataset = cached_breathecam.latest.path;
            }
          }
          if (hashVars.s) {
            loadedTimelapse = true;
            currentLocation = String(hashVars.s);
            changeLocation(currentLocation, startingDate, null, null, false, function() {
              initialDataset = cached_breathecam.datasets[startingDate];
              if (!initialDataset) {
                initialDataset = cached_breathecam.latest.path;
              }
              setupTimelapse(initialDataset, startingDate);
            });
          }
        }

        // If we did not load the timelapse with the hash vars above, do so now.
        if (!loadedTimelapse)
          setupTimelapse(initialDataset, startingDate);
      }

      function img_init() {
        zoomify = new org.gigapan.zoomify({
          onImageReady: function(imgId) {
            showContent();
            if (!$("#timelapse_feed").is(':visible')) {
              selectImageFeed();
            }
          }
        });

        $("#stitched_image").load(function() {
          zoomify.makeImageZoomable("stitched_image");
        });

        $("#stitched_image").bind("mouseover mouseup", function() {
          $(this).removeClass("openHand closedHand").addClass("openHand");
        }).bind("mousedown", function() {
          $(this).removeClass("openHand closedHand").addClass("closedHand");
        });
      }

      function setupTimelapse(initialDataset, startingDate) {
        var settings = {
          url: initialDataset,
          disableTourLooping: true,
          mediaType: ".mp4",
          showFullScreenBtn: false,
          showLogoOnDefaultUI: false,
          datasetType: "breathecam",
          onTimeMachinePlayerReady: function(viewerDivId) {
            repaintCanvasLayer();
            repaintSmellCanvasLayer();
            // Time Machine Listeners
            timelapse.addTimeChangeListener(function(videoTime) {
              if (dateAxis) {
                fixedCursorPosition = Date.parse(timelapse.getCurrentCaptureTime().replace(/-/g, "/")) / 1000;
                dateAxis.setCursorPosition(fixedCursorPosition);
              }
              repaintCanvasLayer();
              repaintSmellCanvasLayer();
            });
            // Override the hashchange event
            window.onhashchange = null;
            $(window).on("hashchange", function() {
              var newHash = window.location.hash.slice(1);
              var newHashVars = org.gigapan.Util.unpackVars(newHash);
              var currentHash = timelapse.getShareView();
              var currentHashVars = org.gigapan.Util.unpackVars(currentHash);
              window.location.hash = "";
              if (!newHashVars) return;

              if ((newHashVars.d && currentHashVars.d != newHashVars.d) || (newHashVars.s && currentHashVars.s != newHashVars.s)) {
                var newDate, newDataset;
                if (newHashVars.d) {
                  newDate = String(newHashVars.d);
                  newDataset = cached_breathecam.datasets[newDate];
                  if (!newDataset) return;
                }
                var newTime = parseFloat(newHashVars.t);
                var newView = timelapse.normalizeView(timelapse.unsafeViewToView(newHashVars.v));
                if (newHashVars.s && currentHashVars.s != newHashVars.s) {
                  currentLocation = String(newHashVars.s);
                  changeLocation(currentLocation, newDate, newView, newTime, true);
                } else {
                  updateCalendarAndToggleUI(newDate);
                  timelapse.loadTimelapse(newDataset, newView, newTime, false);
                }
              } else {
                // Share views
                timelapse.loadSharedViewFromUnsafeURL(org.gigapan.Util.getUnsafeHashString());
              }
            });
            if (!hashVars) {
              var numFrames = timelapse.getNumFrames();
              // 12 fps * 5 seconds = 60 frames
              var fiveSecondsFromEnd = numFrames - 60;
              timelapse.seekToFrame(fiveSecondsFromEnd);
            }
            showContent();
          }
        };
        timelapse = new org.gigapan.timelapse.Timelapse("timeMachine", settings);

        loadCalendar(startingDate);
      }

      function selectTimelapseFeed() {
        $("#image_feed").css("visibility", "hidden");
        $("#stitched_image_wrapper").css("visibility", "hidden");
        $("#stitched_image").css("visibility", "hidden");
        $("#timelapse_feed").show();
        setLocationTitle();
      }

      function selectImageFeed() {
        $("#timelapse_feed").hide();
        $("#image_feed").css("visibility", "visible");
        $("#stitched_image_wrapper").css("visibility", "visible");
        $("#stitched_image").css("visibilriity", "visible");
        $("#location_toggle_container").css("top", "0px");
        setLocationTitle();
      }

      function setLocationTitle() {
        var locationTitle = $("#location_toggle_container .location_thumbnail_selected").siblings(".location_title").text();
        $("#locationTitle").text(locationTitle);
      }

      function showContent() {
        $("#loading").hide();
        $("#content").css("visibility", "visible");
      }

      function changeLocation(locationName, newDate, newView, newTime, doLoad, callBack) {
        currentLocation = locationName;
        if (timelapseFeedUnavailable) {
          location.href = "/embeds/" + locationName;
        } else {
          $.ajax({
            url: "http://tiles.cmucreatelab.org/ecam/timemachines/" + locationName + "/" + locationName + ".json",
            dataType: "json"
          }).done(function(data) {
            cached_breathecam = data;
            var startingDate = cached_breathecam.latest.date;
            var startingDataset = cached_breathecam.latest.path;

            if (newDate) {
              var tmpStartingDataset = cached_breathecam.datasets[newDate];
              if (tmpStartingDataset) {
                startingDate = newDate;
                startingDataset = tmpStartingDataset;
              }
            }
            // If there is no timelapse object at this point, then that means that we have just arrived at the page
            // with a share link that has an invalid location name.
            // Load the timelapse with the default location specified in the .fail() callback below.
            if (!timelapse) {
              setupTimelapse(startingDataset, startingDate);
              return;
            }
            updateCalendarAndToggleUI(locationName, startingDate);
            if (doLoad) {
              if (timelapse && startingDataset) {
                newTime = parseFloat(newTime);
                timelapse.loadTimelapse(startingDataset, newView, newTime, false, null, function() {
                  if (isNaN(newTime)) {
                    var numFrames = timelapse.getNumFrames();
                    // 12 fps * 5 seconds = 60 frames
                    var fiveSecondsFromEnd = numFrames - 60;
                    timelapse.seekToFrame(fiveSecondsFromEnd);
                  }
                });
              }
            } else if (typeof(callBack) === "function") {
              callBack();
            }
          }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR, textStatus, errorThrown);
            changeLocation("heinz", null, null, null, true);
          });
        }
      }

      function updateCalendarAndToggleUI(startingDate) {
        $(".gwt-PopupPanel").remove();
        locationDivId = currentLocation + "_overlay";
        setLocationThumbnailToggle();
        setLocationTitle();
        $("#datepicker").datepicker("destroy");
        loadCalendar(startingDate);
      }

      function loadCalendar(startingDate) {
        pageLoadDate = startingDate;
        currentDate = startingDate;
        var dateArray = startingDate.split("-");
        $("#datepicker").datepicker({
          defaultDate : new Date(dateArray[0], dateArray[1] - 1, dateArray[2]),
          minDate : new Date(2014, 0),
          onSelect : selectDay,
          beforeShowDay : highlightDays
        });
      }

      function highlightDays(date) {
        date = $.datepicker.formatDate('yy-mm-dd', date);
        if (cached_breathecam.datasets[date])
          return [true, 'date-highlight'];
        else
          return [false, ''];
      }

      function selectDay(dateText, dateElem) {
        var date = $.datepicker.formatDate('yy-mm-dd', new Date(dateText));
        var path = cached_breathecam.datasets[date];
        if (timelapse && path) {
          $(".gwt-PopupPanel").remove();
          currentDate = date;
          setGraphTimeRange(date);
          timelapse.loadTimelapse(path, null, null, true);
        }
      }

      function setLocationThumbnailToggle() {
        $(".location_thumbnail_selected").removeClass("location_thumbnail_selected");
        $("#" + locationDivId).addClass("location_thumbnail_selected");
      }

      function getFormattedTime(date) {
        var hours = date.getHours() === 0 ? "12" : date.getHours() > 12 ? date.getHours() - 12 : date.getHours();
        var minutes = (date.getMinutes() < 10 ? "0" : "") + date.getMinutes();
        var seconds = date.getSeconds();
        var ampm = date.getHours() < 12 ? "AM" : "PM";
        var formattedTime = hours + ":" + minutes + ":" + seconds + " " + ampm;
        return formattedTime;
      }

      function requestEsdrExport(requestInfo, callBack) {
        $.ajax({
          crossDomain: true,
          type: "GET",
          dataType: "text",
          url: ESDR_API_ROOT_URL + "/feeds/" + requestInfo.feed_id + "/channels/" + requestInfo.channels + "/export",
          data: { from: requestInfo.start_time, to: requestInfo.end_time, FeedApiKey: requestInfo.api_key},
          success: function(csvData) {
            if (typeof(callBack) === "function")
              callBack(csvData);
          },
          failure: function(data) {
            console.log('Failed to load sensor data.');
          },
          headers: requestInfo.headers
        });
      }

      function parseEsdrCSV(csvData, sensor) {
        var csvArray = csvData.split("\n");
        var headingsArray = csvArray[0].split(",");
        // First row is the CSV headers, which we took care of above, so start at 1.
        for (var i = 1; i < csvArray.length; i++) {
          var csvLineAsArray = csvArray[i].split(",");
          // First entry is the EPOC time, so start at index 1.
          for (var j = 1; j < csvLineAsArray.length; j++) {
            var tmpChannelHeading = headingsArray[j].split(".");
            var channelHeading = tmpChannelHeading[tmpChannelHeading.length - 1];
            var timeStamp = sensor.channels[channelHeading].hourly ? (csvLineAsArray[0] - 1800): csvLineAsArray[0];
            sensor.channels[channelHeading].summary[timeStamp] = parseFloat(csvLineAsArray[j]);
          }
        }
      }

      var createChart = function(feed, channelName, feedAPIKey) {
        var startTime = feed.fullTimeRange.min;
        var endTime = feed.fullTimeRange.max;

        // Initial creation
        if (!$("#dateAxisContainer").length) {
          $("#grapher").append('<tr id="dateAxisContainer" class="grapher_row"><td id="sensorColumnTitle">Location / Sensor</td><td id="dateAxis"></td><td></td></tr>');
          dateAxis = new DateAxis("dateAxis", "horizontal", {
            min: startTime,
            max: endTime
          });
          dateAxis.setCursorColor("#1A1A1A");
          dateAxis.addAxisChangeListener(function(e) {
            // Boo, grapher hacks abound...
            var $gwtPopupPanels = $(".gwt-PopupPanel");
            if ($gwtPopupPanels.length && (fixedCursorPosition < dateAxis.getMin() || fixedCursorPosition > dateAxis.getMax())) {
              $gwtPopupPanels.each(function() {
                if ($(this).text() == gwtPopUpText) {
                  $(this).hide();
                } else if ($gwtPopupPanels.length == 1) {
                  $(this).show();
                }
              });
            }
            if (e) {
              var cursorPosition = e.cursorPosition;
              if (fixedCursorPosition != cursorPosition) {
                // Reset the cursor position
                dateAxis.setCursorPosition(fixedCursorPosition);
              }
            }
            if (clampTimeout) return;
            clampTimeout = window.setTimeout(function() {
              for (var seriesCount = 0; seriesCount < series.length; seriesCount++) {
                var plots = series[seriesCount].p;
                clampNumberAxisToDataRange(plots, seriesCount);
              }
              window.clearTimeout(clampTimeout);
              clampTimeout = null;
            }, 150);
          });
          dateAxis.setMaxRange(null, endTime);
          setGraphTimeRange(pageLoadDate);
          addSmellReportsToGrapher();
          if (timelapse) {
            var currentCaptureTime = timelapse.getCurrentCaptureTime();
            if (currentCaptureTime) {
              fixedCursorPosition = Date.parse(currentCaptureTime.replace(/-/g, "/")) / 1000;
              dateAxis.setCursorPosition(fixedCursorPosition);
            }
          }
        }

        // Set max range of all the graphs
        if (endTime > dateAxis.getMax()) {
          dateAxis.setMaxRange(null, endTime);
        }

        // Add charts
        var seriesIdx = series.length;
        var color_line = "rgb(" + feed.channels[channelName].graphMetaData.color + ")";
        var color_fill = "rgba(" + feed.channels[channelName].graphMetaData.color + ",1)";

        if (feed.feed_id == 4615) {
          seriesIdx = 2;
        } else if (feed.feed_id == 4616) {
          seriesIdx = 4;
        } else {
          series[seriesIdx] = {};
          series[seriesIdx].id = seriesIdx;
          var row = $('<tr class="chart grapher_row"' + 'data-channel=' + channelName + '></tr>');
          row.append('<td class="chartTitle" style="background:' + color_fill + '">' + feed.channels[channelName].graphMetaData.label + '</td>');
          row.append('<td id="series' + seriesIdx + '" class="chartContent"></td>');
          row.append('<td id="series' + seriesIdx + 'axis" class="chartAxis"></td>');
          $('#grapher').append(row);
          series[seriesIdx].axis = new NumberAxis('series' + seriesIdx + 'axis', "vertical");
        }

        var datasource;
        (function(source) {
          datasource = function(level, offset, successCallback, failureCallback) {
            $.ajax({
              type: "GET",
              dataType: "json",
              url: ESDR_API_ROOT_URL + "/feeds/" + feedAPIKey + "/channels/" + source + "/tiles/" + level + "." + offset,
              success: function(json) {
                successCallback(JSON.stringify(json.data));
              },
              failure: failureCallback
            });
          };
        })(channelName);
        var plot = new DataSeriesPlot(datasource, dateAxis, series[seriesIdx].axis, {});

        plot.addDataPointListener(function(pointData, event) {
          if (!event) return;
          if (event.actionName == "click") {
            fixedCursorPosition = pointData.date;
            var pointDataDateObj = new Date(pointData.dateString.split(".")[0]);
            var commentDate = $.datepicker.formatDate('yy-mm-dd', pointDataDateObj);
            if (commentDate != currentDate) {
              var path = cached_breathecam.datasets[commentDate];
              var currentView = timelapse.getView();
              currentDate = commentDate;
              timelapse.loadTimelapse(path, currentView, null, null, pointDataDateObj);
              $("#datepicker").datepicker("setDate", pointDataDateObj);
            } else {
              var desiredDateString = pointData.dateString.split(", ")[1];
              var closestDesiredFrame = timelapse.findExactOrClosestCaptureTime(desiredDateString.substr(0, 8));
              timelapse.seekToFrame(closestDesiredFrame);
            }
          }
        });

        var cursorColor = (feed.feed_id == 4615 || feed.feed_id == 4616) ? "rgba(0,0,0,0)" : "#2A2A2A";
        plot.setStyle({
          "cursor" : {
            "color" : cursorColor,
            "lineWidth" : 1
          },
          "styles": [
            { "type" : "line", "lineWidth" : 1, "show" : true, "color" : color_line }/*,
            { "type" : "circle", radius : 1, "lineWidth" : 1, "show" : true, "color" : color_line, fill : true }*/
          ],
          "highlight" : {
            "lineWidth" : 1,
            "styles" : [
               {
                  "type" : "circle",
                  radius : 3.5,
                  "lineWidth" : 0.5,
                  "show" : true,
                  "color" : "#2A2A2A",
                  fill : true,
                  fillColor: "#2A2A2A"
               },
               {
                  "show" : true,
                  "type" : "value",
                  "fillColor" : "#000000",
                  "marginWidth" : 10,
                  "font" : "12pt Helvetica,Arial,Verdana,sans-serif",
                  "verticalOffset" : 5,
                  "horizontalOffset" : 12,
                  "numberFormat" : "###,##0.#"
               }
            ]
          }
        });

        if (feed.feed_id == 4615 || feed.feed_id == 4616) {
          series[seriesIdx].pc.addPlot(plot);
        } else {
          series[seriesIdx].p = [];
          series[seriesIdx].pc = new PlotContainer("series" + seriesIdx, false, [plot]);
        }
        series[seriesIdx].p.push(plot);

        setSizes();

        var plotIdx = series[seriesIdx].p.length - 1;
        if (!series[seriesIdx].loadingIntervalCounts) {
          series[seriesIdx].loadingIntervalCounts = {};
          series[seriesIdx].checkPlotLoadedIntervals = {};
        }
        series[seriesIdx].loadingIntervalCounts[plotIdx] = 0;
        series[seriesIdx].checkPlotLoadedIntervals[plotIdx] = setInterval(function(){
          clampNumberAxisToDataRange(series[seriesIdx].p, seriesIdx);
          series[seriesIdx].loadingIntervalCounts[plotIdx]++;
        }, 100);

      };

      function clampNumberAxisToDataRange(plots, seriesIdx) {
        var stats, min = 9999, max = -9999;
        if (plots.constructor === Array) {
          for (var i = 0; i < plots.length; i++) {
            if (series[seriesIdx].loadingIntervalCounts && series[seriesIdx].loadingIntervalCounts[i] >= 20) {
              clearInterval(series[seriesIdx].checkPlotLoadedIntervals[i]);
            }
            stats = plots[i].getSimpleStatistics(dateAxis.getMin(), dateAxis.getMax());
            if (min > stats.y_min) min = stats.y_min;
            if (max < stats.y_max) max = stats.y_max;
          }
        } else {
          if (series[seriesIdx].loadingIntervalCounts[0] >= 20) {
            clearInterval(series[seriesIdx].checkPlotLoadedIntervals[0]);
          }
          stats = plots.getSimpleStatistics(dateAxis.getMin(), dateAxis.getMax());
          min = stats.y_min;
          max = stats.y_max;
        }

        if (stats.has_data && typeof stats.y_min !== 'undefined' && typeof stats.y_max !== 'undefined') {
          var paddedRange = paddedYAxisRange(min, max);
          series[seriesIdx].axis.setRange(paddedRange.min, paddedRange.max);
        }
      }

      function paddedYAxisRange(min, max) {
        var yDiff = max - min;
        var padding = 0.5;
        if (yDiff < 1e-10) {
          padding = 0.5;
        } else {
          padding = 0.05 * yDiff;
        }
        return {min : min - padding, max : max + padding};
      }

      function setSizes() {
        var width = $(window).width() / 2;
        var height = $(window).height() / 2;
        if (!dateAxis) return;
        $("#grapher").css({"width" : width + "px", "height" : height + "px"});
        $("#dateAxis").width($('.chartContent').width());
        var dateAxisWidth = $('#dateAxis').width();
        var dateAxisHeight = $('#dateAxis').height();
        $('.chartContent').height($('.chart').height() - 1);
        $('.chartTitle').height($('.chart').height() - 23);
        $('.chartAxis').height($('.chart').height() - 1);
        if (!dateAxisWidth || !dateAxisHeight) return;
        dateAxis.setSize(dateAxisWidth, dateAxisHeight, SequenceNumber.getNext());
        for (var i = 0; i < series.length; i++) {
          var newHeight = $('.chart').height();
          if (i === 0)
            newHeight = $('.annotationContent').height();
          series[i].axis.setSize($('#series' + i + 'axis').width(), newHeight, SequenceNumber.getNext());
          series[i].pc.setSize($('#series' + i).width(), newHeight, SequenceNumber.getNext());
        }
      }

      function setGraphTimeRange(date) {
        if (!dateAxis) return;
        var dayStartString = date + " 00:00:00";
        var dayEndString = date + " 23:59:59";
        var dayStart = (new Date((dayStartString).replace(/-/g,"/")).getTime()) / 1000;
        var dayEnd = (new Date((dayEndString).replace(/-/g,"/")).getTime()) / 1000;
        dateAxis.setRange(dayStart, dayEnd);
      }

      function initialize() {
        // Initialize E-Cam
        var timelapseSupported = org.gigapan.Util.browserSupported();
        var stitchedImage = "N/A";
        locationDivId = "shenango1" + "_overlay";
        setLocationThumbnailToggle();
        $(".location_thumbnail_container").on("click", function() {
          window.location.hash = "";
          changeLocation($(this).attr("data-location-id"), null, null, null, true);
        });
        if ((!timelapseSupported || typeof (cached_breathecam) === "undefined") && stitchedImage === "") {
          // Nothing is up. Hide containers and inform the user
          $("#stitched_image_wrapper").hide();
          $("#location_toggle").hide();
          $("#loading").html("<div class='error_msg2'>Content currently unavailable. Please try again later.</div>");
        } else if (!timelapseSupported || typeof (cached_breathecam) === "undefined") {
          timelapseFeedUnavailable = true;
          // TODO: Image feed is not working since the-shenango-channel currently does not have a way to get the latest image,
          // unlike when it was running on the Rails server.
          // Timelapse unavailable, show latest stitched pano
          // Calendar is gone in this mode, so move thumbnail toggles to top of page
          $("#location_toggle").css({'top':'0px'});
          $("#image_feed_timestamp").css({"top" : "48px", "right" : "22px"});
          img_init();
        } else {
          // Show timelapse
          tm_init();
        }
        $("#container").on("mousedown", function() { return false; });

        // Initialize Map
        initMap('map-canvas');

        // Initialize Smells
        initSmells();

        // Initialize Graphs
        window.grapherLoad = function() {
          var feedNames = Object.keys(esdr_feeds).sort();
          for (var i = 0; i < feedNames.length; i++) {
            (function(i){
              $.ajax({
                type: "GET",
                dataType: "json",
                url: ESDR_API_ROOT_URL + '/feeds/' + esdr_feeds[feedNames[i]].api_key,
                success: function(json) {
                  esdr_feeds[feedNames[i]].fullTimeRange.min = json.data.minTimeSecs;
                  esdr_feeds[feedNames[i]].fullTimeRange.max = json.data.maxTimeSecs;
                  if (i == feedNames.length - 1) {
                    for (var j = 0; j < feedNames.length; j++) {
                      (function(j){
                        var feed = esdr_feeds[feedNames[j]];
                        var channelNames = Object.keys(feed.channels);
                        channelNames.forEach(function(channelName) {
                          if (!feed.channels[channelName].show_graph) return;
                          window.setTimeout(function() {
                            createChart(feed, channelName, feed.api_key);
                          }, j*50);
                        });
                      })(j);
                    }
                  }
                }
              });
            })(i);
          }
        };

        // Load sensor summaries (i.e. ESDR exports)

        //var sensors = Object.keys(esdr_feeds);
        //var today = new Date();
        //var newDateString =  (today.getMonth() + 1) + "/" + today.getDate() + "/" + today.getFullYear();
        //var firstCaptureTime = newDateString + " 00:00:00";
        //var lastCaptureTime = newDateString + " 23:59:59";
        //var startTime = (new Date((firstCaptureTime).replace(/-/g,"/")).getTime()) / 1000;
        //var endTime = (new Date((lastCaptureTime).replace(/-/g,"/")).getTime()) / 1000;

        //for (var i = 0; i < sensors.length; i++) {
        //  (function(i){
        //    var sensor = esdr_feeds[sensors[i]];
        //    var channels = Object.keys(sensor.channels).toString();
        //    var requestInfo = {
        //      feed_id : sensor.feed_id,
        //      api_key : sensor.api_key,
        //      start_time : startTime,
        //      end_time : endTime,
        //      channels : channels,
        //      headers : null
        //    };
        //    requestEsdrExport(requestInfo, function(csvData) {
        //      parseEsdrCSV(csvData, sensor);
        //    });
        //  })(i);
        //}
      }
      $(initialize);
      $(window).resize(function() {
        setSizes();
        google.maps.event.trigger(map, 'resize');
      });
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-10682694-14', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <table id="page_container" border="0" cellspacing="0" cellpadding="0">
      <tr class="page_row">
        <td colspan="2" height="50%">
          <div id="container">
            <div id="loading">
              <img id="loadingImg" src="assets/images/loading.gif" width="358" height="250" alt="loading">
            </div>
            <div id="locationTitle"></div>
            <div id="timelapse_feed" class="timelapse_feed_embed">
              <div id="timeMachine"></div>
              <div id="datepicker" class="datepicker_embed"></div>
            </div>
            <div id="image_feed" class="image_feed_embed">
              <div id="stitched_image_wrapper" class="image-zoom-wrapper image-zoom-wrapper-embed">
                <div id="zoom-in" title="Zoom in"><p>+</p></div>
                <div id="zoom-out" title="Zoom out"><p>_</p></div>
                <img id="stitched_image" class="image-zoom" src="#" alt="Latest Stitch">
                <span id="image_feed_timestamp">03/09/2015 03:16 PM</span>
              </div>
            </div>
            <div id="location_toggle_container">
              <a class="location_thumbnail_container" data-location-id="shenango1" href="javascript:void(0)">
                <div id="shenango1_overlay" class="location_thumbnail_overlay"></div>
                <img src="assets/images/shenango1.png" class="location_thumbnail" alt="Shenango1">
                <div class="location_title">Shenango (Leah)</div>
              </a>
              <a class="location_thumbnail_container location_thumbnail_container_end" data-location-id="shenango2" href="javascript:void(0)">
                <div id="shenango2_overlay" class="location_thumbnail_overlay"></div>
                <img src="assets/images/shenango2.png" class="location_thumbnail" alt="Shenango2">
                <div class="location_title">Shenango (Metro Motors)</div>
              </a>
            </div>
          </div>
        </td>
      </tr>
      <tr class="page_row">
        <td valign="top" width="50%" height="50%"><table id="grapher" border="0" cellspacing="0" cellpadding="0"></table></td>
        <td valign="top" width="100px" height="50%"><div id="map-canvas"></div></td>
      </tr>
    </table>
    <div style="font-family: Custom-Calibri;">.</div>
  </body>
</html>
